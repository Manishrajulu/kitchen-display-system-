<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Staff Login - KDS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .login-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        .login-btn:hover {
            background-color: #0056b3;
        }
        .counter-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .orders-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .order-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .order-item.status-new { border-left-color: #28a745; }
        .order-item.status-in_progress { border-left-color: #ffc107; }
        .order-item.status-ready { border-left-color: #dc3545; }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-new { background-color: #d4edda; color: #155724; }
        .status-in_progress { background-color: #fff3cd; color: #856404; }
        .status-ready { background-color: #f8d7da; color: #721c24; }
        .update-btn {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-new { background-color: #28a745; color: white; }
        .btn-progress { background-color: #ffc107; color: black; }
        .btn-ready { background-color: #dc3545; color: white; }
        .btn-cancel { background-color: #6c757d; color: white; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>üçΩÔ∏è Kitchen Staff Login</h1>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="counterSelect">Select Your Counter:</label>
                <select id="counterSelect" required>
                    <option value="">Choose your counter...</option>
                    <!-- Counters will be loaded dynamically -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="pinInput">Enter PIN:</label>
                <input type="password" id="pinInput" placeholder="Enter your PIN" required>
            </div>
            
            <button type="submit" class="login-btn">üîê Login to Counter</button>
            <button type="button" onclick="clearLoginState()" style="background-color: #6c757d; color: white; margin-left: 10px;">üóëÔ∏è Clear Saved Login</button>
            <button type="button" onclick="loadAvailableCounters()" style="background-color: #28a745; color: white; margin-left: 10px;">üîÑ Refresh Counters</button>
        </form>
        
        <div id="loginStatus"></div>
        
        <div id="counterInfo" style="display: none;">
            <div class="counter-info">
                <h3 id="counterName"></h3>
                <p id="counterDescription"></p>
                <div id="connectionStatus" style="margin: 10px 0; padding: 5px; border-radius: 4px; font-size: 12px;">
                    <span id="wsStatus">üîå Connecting...</span>
                </div>
                <button type="button" id="refreshOrdersBtn">üîÑ Refresh Orders</button>
                <button type="button" id="logoutBtn">üö™ Logout</button>
                <button type="button" id="clearLoginBtn" style="background-color: #dc3545; color: white;">üóëÔ∏è Clear Login</button>
            </div>
            
            <div class="orders-section">
                <h3>üìã Your Orders</h3>
                <div id="ordersList">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
            
            <div class="orders-section">
                <h3>üìù Real-time Activity Log</h3>
                <div id="log" class="log">
                    <!-- Real-time updates will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCounter = null;
        let currentCounterId = null;
        let websocket = null;

        // Load login state from localStorage on page load
        function loadLoginState() {
            const savedCounter = localStorage.getItem('currentCounter');
            const savedCounterId = localStorage.getItem('currentCounterId');
            
            if (savedCounter && savedCounterId) {
                try {
                    currentCounter = JSON.parse(savedCounter);
                    currentCounterId = parseInt(savedCounterId);
                    
                    // Validate that the saved data is complete
                    if (currentCounter && currentCounter.counter_name && currentCounter.counter_id) {
                        // Restore UI state
                        document.getElementById('loginStatus').innerHTML = 
                            `<div class="status success">‚úÖ Login successful! Welcome to ${currentCounter.counter_name}</div>`;
                        document.getElementById('counterName').textContent = currentCounter.counter_name;
                        document.getElementById('counterDescription').textContent = 
                            `Counter ID: ${currentCounter.counter_id} | You are now logged in`;
                        document.getElementById('counterInfo').style.display = 'block';
                        document.getElementById('loginForm').style.display = 'none';
                        
                        // Reconnect WebSocket
                        connectWebSocket();
                    } else {
                        console.error('Invalid saved login state');
                        clearLoginState();
                    }
                } catch (e) {
                    console.error('Error loading login state:', e);
                    clearLoginState();
                }
            }
        }

        // Save login state to localStorage
        function saveLoginState() {
            if (currentCounter && currentCounterId) {
                localStorage.setItem('currentCounter', JSON.stringify(currentCounter));
                localStorage.setItem('currentCounterId', currentCounterId.toString());
            }
        }

        // Clear login state from localStorage
        function clearLoginState() {
            localStorage.removeItem('currentCounter');
            localStorage.removeItem('currentCounterId');
            
            // Reset UI to login form
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('counterInfo').style.display = 'none';
            document.getElementById('loginStatus').innerHTML = '';
            document.getElementById('ordersList').innerHTML = '';
            
            // Reset variables
            currentCounter = null;
            currentCounterId = null;
        }

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            addLogMessage('üîÑ Login form submitted');
            
            const counterId = document.getElementById('counterSelect').value;
            const pin = document.getElementById('pinInput').value;
            
            addLogMessage(`üîÑ Attempting login with Counter ID: ${counterId}, PIN: ${pin ? '****' : 'empty'}`);
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/kds/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ counter_id: parseInt(counterId), pin: pin })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentCounter = data.user;
                    currentCounterId = counterId;
                    
                    // Save login state to localStorage
                    saveLoginState();
                    
                    document.getElementById('loginStatus').innerHTML = 
                        `<div class="status success">‚úÖ Login successful! Welcome to ${data.user.counter_name}</div>`;
                    
                    document.getElementById('counterName').textContent = data.user.counter_name;
                    document.getElementById('counterDescription').textContent = 
                        `Counter ID: ${data.user.counter_id} | You are now logged in`;
                    
                    document.getElementById('counterInfo').style.display = 'block';
                    document.getElementById('loginForm').style.display = 'none';
                    
                    // Connect to WebSocket for real-time updates
                    connectWebSocket();
                    
                    // Load orders for this counter
                    loadOrders();
                } else {
                    document.getElementById('loginStatus').innerHTML = 
                        `<div class="status error">‚ùå Login failed: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('loginStatus').innerHTML = 
                    `<div class="status error">‚ùå Connection error: ${error.message}</div>`;
            }
        });

        // Load orders for current counter
        async function loadOrders() {
            if (!currentCounterId) {
                addLogMessage(`‚ùå No counter ID - cannot load orders`);
                return;
            }
            
            addLogMessage(`üîÑ Loading orders for counter ${currentCounterId}...`);
            
            try {
                const response = await fetch(`http://127.0.0.1:8000/api/kds/orders/counter/${currentCounterId}/`);
                const orders = await response.json();
                
                addLogMessage(`üì° Received ${orders.length} orders from API`);
                displayOrders(orders);
            } catch (error) {
                addLogMessage(`‚ùå Error loading orders: ${error.message}`);
                document.getElementById('ordersList').innerHTML = 
                    `<div class="status error">‚ùå Error loading orders: ${error.message}</div>`;
            }
        }

        // Display orders
        function displayOrders(orders) {
            const container = document.getElementById('ordersList');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<p>No orders assigned to your counter</p>';
                return;
            }
            
            let html = '';
            orders.forEach(order => {
                html += createOrderHtml(order);
            });
            
            container.innerHTML = html;
            addLogMessage(`üìã Displayed ${orders.length} orders`);
        }

        // Track active updates to prevent multiple rapid clicks
        let activeUpdates = new Set();

        // BULLETPROOF status update function
        function updateItemStatusDirect(itemId, status) {
            console.log('=== BUTTON CLICKED ===');
            console.log('ItemId:', itemId);
            console.log('Status:', status);
            
            addLogMessage(`üî• BUTTON CLICKED: ${itemId} -> ${status}`);
            
            // Prevent any default behavior immediately
            if (window.event) {
                window.event.preventDefault();
                window.event.stopPropagation();
                window.event.stopImmediatePropagation();
            }
            
            try {
                // Find the item element
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                console.log('Item element found:', itemElement);
                
                if (!itemElement) {
                    addLogMessage(`‚ùå Item element not found: ${itemId}`);
                    return false;
                }
                
                // Get order ID and item index
                const orderId = itemElement.getAttribute('data-order-id');
                const itemIndex = itemElement.getAttribute('data-item-index');
                
                console.log('OrderId:', orderId, 'ItemIndex:', itemIndex);
                
                if (!orderId || itemIndex === null) {
                    addLogMessage(`‚ùå Missing order data for ${itemId}`);
                    return false;
                }
                
                addLogMessage(`üîÑ Making API call for order ${orderId}, item ${itemIndex}, status ${status}`);
                
                // Make API call with error handling
                fetch('http://127.0.0.1:8000/api/kds/orders/update-item-status/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        order_id: orderId, 
                        item_index: parseInt(itemIndex), 
                        status: status 
                    })
                })
                .then(response => {
                    console.log('API Response:', response);
                    addLogMessage(`üîÑ API response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('API Data:', data);
                    addLogMessage(`üîÑ API response data: ${JSON.stringify(data)}`);
                    if (data.success) {
                        addLogMessage(`‚úÖ Status updated successfully`);
                        // Update display
                        updateItemStatusInDisplay(itemId, status);
                    } else {
                        addLogMessage(`‚ùå API error: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('API Error:', error);
                    addLogMessage(`‚ùå API error: ${error.message}`);
                });
                
            } catch (error) {
                console.error('Function Error:', error);
                addLogMessage(`‚ùå Error in updateItemStatusDirect: ${error.message}`);
            }
            
            // Always return false to prevent any default behavior
            return false;
        }

        // Simplified status update handler
        function handleStatusUpdateSimple(itemId, status) {
            return updateItemStatusDirect(itemId, status);
        }

        // Legacy function for compatibility
        function handleStatusUpdate(itemId, status, event) {
            return handleStatusUpdateSimple(itemId, status);
        }

        // Legacy updateItemStatus function - now just calls the direct version
        function updateItemStatus(itemId, status) {
            return updateItemStatusDirect(itemId, status);
        }

        // WebSocket connection
        function connectWebSocket() {
            if (currentCounterId) {
                // Don't create multiple connections
                if (websocket && (websocket.readyState === WebSocket.OPEN || websocket.readyState === WebSocket.CONNECTING)) {
                    console.log('WebSocket already connected or connecting');
                    return;
                }
                
                // Close existing WebSocket connection if any
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    console.log('Closing existing WebSocket connection');
                    websocket.close();
                }
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//127.0.0.1:8000/ws/kitchen/?counter_id=${currentCounterId}`;
                
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('WebSocket connected');
                    document.getElementById('wsStatus').innerHTML = '‚úÖ Connected - Real-time updates enabled';
                    document.getElementById('connectionStatus').style.backgroundColor = '#d4edda';
                    document.getElementById('connectionStatus').style.color = '#155724';
                    addLogMessage('üîå WebSocket connected - Real-time updates enabled');
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket disconnected');
                    document.getElementById('wsStatus').innerHTML = '‚ùå Disconnected - Real-time updates disabled';
                    document.getElementById('connectionStatus').style.backgroundColor = '#f8d7da';
                    document.getElementById('connectionStatus').style.color = '#721c24';
                    addLogMessage('‚ùå WebSocket disconnected - Real-time updates disabled');
                    
                    // Don't refresh the page or reset login state on WebSocket disconnect
                    // Just try to reconnect after a delay
                    setTimeout(() => {
                        if (currentCounterId) {
                            console.log('Attempting to reconnect WebSocket...');
                            connectWebSocket();
                        }
                    }, 5000);
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    document.getElementById('wsStatus').innerHTML = '‚ùå Error - Check server connection';
                    document.getElementById('connectionStatus').style.backgroundColor = '#f8d7da';
                    document.getElementById('connectionStatus').style.color = '#721c24';
                    addLogMessage('‚ùå WebSocket error - Check server connection');
                };
            }
        }
        
        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'initial_data':
                    if (data.orders && data.orders.length > 0) {
                        displayOrders(data.orders);
                        addLogMessage(`üìã Initial data loaded: ${data.orders.length} orders`);
                    } else {
                        addLogMessage(`üìã No orders in initial data`);
                    }
                    break;
                    
                case 'new_order':
                    addLogMessage(`üÜï New order received: ${data.order.order_number}`);
                    // Add the new order directly to the display (already filtered by WebSocket)
                    addOrderToDisplay(data.order);
                    addLogMessage(`‚úÖ Order ${data.order.order_number} added to display`);
                    break;
                    
                case 'order_update':
                    addLogMessage(`üîÑ Order updated: ${data.order.order_number}`);
                    // Update the order directly in the display (already filtered by WebSocket)
                    updateOrderInDisplay(data.order);
                    addLogMessage(`‚úÖ Order ${data.order.order_number} updated in display`);
                    break;
                    
                case 'order_deleted':
                    addLogMessage(`üóëÔ∏è Order deleted: ${data.order_id}`);
                    // Remove the order directly from display
                    removeOrderFromDisplay(data.order_id);
                    addLogMessage(`‚úÖ Order ${data.order_id} removed from display`);
                    break;
                    
                case 'item_status_update':
                    addLogMessage(`üìù Item ${data.item_id} status updated to ${data.status}`);
                    // Update item status directly in display
                    updateItemStatusInDisplay(data.item_id, data.status);
                    addLogMessage(`‚úÖ Item ${data.item_id} status updated in display`);
                    break;
                    
                case 'pong':
                    // Keep-alive response
                    break;
                    
                default:
                    console.log('Unknown WebSocket message:', data);
            }
        }
        
        // Add log message
        function addLogMessage(message) {
            const logDiv = document.getElementById('log');
            if (logDiv) {
                const timestamp = new Date().toLocaleTimeString();
                logDiv.innerHTML += `[${timestamp}] ${message}\n`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }
        
        // Add new order to display
        function addOrderToDisplay(order) {
            const container = document.getElementById('ordersList');
            const orderHtml = createOrderHtml(order);
            container.insertAdjacentHTML('beforeend', orderHtml);
        }
        
        // Update existing order in display
        function updateOrderInDisplay(order) {
            const container = document.getElementById('ordersList');
            const existingOrder = container.querySelector(`[data-order-id="${order.id}"]`);
            if (existingOrder) {
                existingOrder.outerHTML = createOrderHtml(order);
            } else {
                // If order doesn't exist, add it
                addOrderToDisplay(order);
            }
        }
        
        // Remove order from display
        function removeOrderFromDisplay(orderId) {
            const container = document.getElementById('ordersList');
            const existingOrder = container.querySelector(`[data-order-id="${orderId}"]`);
            if (existingOrder) {
                existingOrder.remove();
            }
        }
        
        // Update item status in display
        function updateItemStatusInDisplay(itemId, status) {
            const container = document.getElementById('ordersList');
            const itemElement = container.querySelector(`[data-item-id="${itemId}"]`);
            if (itemElement) {
                // Update status badge
                const statusBadge = itemElement.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = status;
                    statusBadge.className = `status-badge status-${status}`;
                }
                
                // Update status select
                const statusSelect = itemElement.querySelector('select');
                if (statusSelect) {
                    statusSelect.value = status;
                }
            }
        }
        
        // Create HTML for order
        function createOrderHtml(order) {
            let html = `
                <div class="order-item" data-order-id="${order.id}">
                    <h4>${order.order_number || 'N/A'} - Table ${order.table_number || 'N/A'}</h4>
                    <p><strong>Customer:</strong> ${order.customer_name || 'N/A'}</p>
                    <p><strong>Total:</strong> $${order.total_amount || 0}</p>
                    <div class="order-items">
            `;
            
            order.items.forEach((item, index) => {
                // Generate a unique item ID for this specific order and item
                const itemId = `item_${order.id}_${index}`;
                html += `
                    <div class="order-item status-${item.status || 'pending'}" data-item-id="${itemId}" data-order-id="${order.id}" data-item-index="${index}">
                        <div>
                            <strong>${item.name || 'Unknown Item'}</strong> x${item.quantity || 1}
                            <br><small>${item.category || 'Unknown Category'}</small>
                        </div>
                        <div>
                            <span class="status-badge status-${item.status || 'pending'}">${item.status || 'pending'}</span>
                            <span class="update-btn btn-new" onclick="updateStatus('${itemId}', 'pending')" style="cursor: pointer; padding: 5px 10px; margin: 2px; background-color: #28a745; color: white; border-radius: 3px; display: inline-block;">New</span>
                            <span class="update-btn btn-progress" onclick="updateStatus('${itemId}', 'in_progress')" style="cursor: pointer; padding: 5px 10px; margin: 2px; background-color: #ffc107; color: black; border-radius: 3px; display: inline-block;">Start</span>
                            <span class="update-btn btn-ready" onclick="updateStatus('${itemId}', 'ready')" style="cursor: pointer; padding: 5px 10px; margin: 2px; background-color: #dc3545; color: white; border-radius: 3px; display: inline-block;">Ready</span>
                            <span class="update-btn btn-cancel" onclick="updateStatus('${itemId}', 'cancelled')" style="cursor: pointer; padding: 5px 10px; margin: 2px; background-color: #6c757d; color: white; border-radius: 3px; display: inline-block;">Cancel</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }
        
        // Logout
        function logout() {
            // Close WebSocket connection
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            currentCounter = null;
            currentCounterId = null;
            
            // Clear login state from localStorage
            clearLoginState();
            
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('counterInfo').style.display = 'none';
            document.getElementById('loginStatus').innerHTML = '';
            document.getElementById('ordersList').innerHTML = '';
            document.getElementById('loginForm').reset();
        }

        // Real-time updates via WebSocket - no need for polling
        
        // Global error handler to prevent page crashes
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            addLogMessage(`‚ùå Error: ${event.error?.message || 'Unknown error'}`);
            // Prevent the error from causing a page reload
            event.preventDefault();
            event.stopPropagation();
            return false;
        });

        // Removed global click handler to prevent interference

        // Additional error handler for uncaught exceptions
        window.addEventListener('uncaughtException', function(event) {
            console.error('Uncaught exception:', event.error);
            addLogMessage(`‚ùå Uncaught exception: ${event.error?.message || 'Unknown error'}`);
            event.preventDefault();
            return false;
        });

        // Prevent any form submissions from causing page reloads (except login form)
        document.addEventListener('submit', function(event) {
            // Allow login form to work normally
            if (event.target.id === 'loginForm') {
                console.log('Login form submission allowed');
                return; // Let the login form handle its own submission
            }
            
            console.log('Form submission prevented:', event.target);
            addLogMessage('üö´ Form submission prevented to avoid page reload');
            event.preventDefault();
            event.stopPropagation();
            return false;
        });

        // Removed global button click detector to prevent interference

        // Remove beforeunload handler - it was causing the reload dialog
        // The beforeunload handler was the root cause of the "Reload site?" dialog

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            addLogMessage(`‚ùå Promise error: ${event.reason?.message || 'Unknown promise error'}`);
            // Prevent the error from causing a page reload
            event.preventDefault();
        });

        // Removed beforeunload handler - it was causing the reload dialog

        // Simple function that will definitely work
        function updateStatus(itemId, status) {
            console.log('updateStatus called:', itemId, status);
            addLogMessage(`üî• Status update: ${itemId} -> ${status}`);
            
            // Find the item element
            const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
            if (!itemElement) {
                addLogMessage(`‚ùå Item element not found: ${itemId}`);
                return;
            }
            
            // Get order ID and item index
            const orderId = itemElement.getAttribute('data-order-id');
            const itemIndex = itemElement.getAttribute('data-item-index');
            
            if (!orderId || itemIndex === null) {
                addLogMessage(`‚ùå Missing order data for ${itemId}`);
                return;
            }
            
            addLogMessage(`üîÑ Making API call for order ${orderId}, item ${itemIndex}, status ${status}`);
            
            // Make API call
            fetch('http://127.0.0.1:8000/api/kds/orders/update-item-status/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    order_id: orderId, 
                    item_index: parseInt(itemIndex), 
                    status: status 
                })
            })
            .then(response => response.json())
            .then(data => {
                addLogMessage(`üîÑ API response: ${JSON.stringify(data)}`);
                if (data.success) {
                    addLogMessage(`‚úÖ Status updated successfully`);
                    // Update display
                    updateItemStatusInDisplay(itemId, status);
                } else {
                    addLogMessage(`‚ùå API error: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                addLogMessage(`‚ùå API error: ${error.message}`);
                console.error('API error:', error);
            });
        }

        // Make the function globally available
        window.updateItemStatusDirect = updateItemStatusDirect;
        window.updateStatus = updateStatus;

        // Global error handler to prevent page reloads
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            addLogMessage(`‚ùå Global error: ${event.error?.message || 'Unknown error'}`);
            event.preventDefault();
            event.stopPropagation();
            return false;
        });

        // Prevent any form submissions that might cause reloads (except login form)
        window.addEventListener('submit', function(event) {
            if (event.target.id !== 'loginForm') {
                console.log('Form submission prevented:', event.target);
                addLogMessage('üö´ Form submission prevented');
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
        });

        // Orders form removed - no longer needed

        // Load available counters
        async function loadAvailableCounters() {
            try {
                addLogMessage('üîÑ Loading counters from API...');
                const response = await fetch('http://127.0.0.1:8000/api/kds/counters/');
                addLogMessage(`üì° API Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const counters = await response.json();
                addLogMessage(`üìã Received ${counters.length} counters from API`);
                console.log('Counters received:', counters);
                
                const select = document.getElementById('counterSelect');
                
                if (counters.length === 0) {
                    select.innerHTML = '<option value="">No counters available - Create counters first</option>';
                    addLogMessage('‚ö†Ô∏è No counters available. Please create counters in the Order Management page first.');
                } else {
                    select.innerHTML = '<option value="">Choose your counter...</option>';
                    counters.forEach(counter => {
                        select.innerHTML += `<option value="${counter.id}">${counter.name} (PIN: ${counter.pin})</option>`;
                        addLogMessage(`‚úÖ Added counter: ${counter.name} (ID: ${counter.id})`);
                    });
                    addLogMessage(`üìã Loaded ${counters.length} available counters`);
                }
            } catch (error) {
                addLogMessage(`‚ùå Error loading counters: ${error.message}`);
                console.error('Counter loading error:', error);
            }
        }

        // Initialize on page load
        window.onload = function() {
            addLogMessage('üöÄ KDS System Loaded - Please login to your counter');
            
            // Load available counters
            loadAvailableCounters();
            
            // Set up event delegation for dynamically created buttons
            setupEventDelegation();
            
            // Check if user wants to force fresh login
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('fresh') === 'true') {
                clearLoginState();
                addLogMessage('üîÑ Fresh login requested - please login again');
            } else {
                // Load saved login state if available
                loadLoginState();
            }
        };

        // Simple event delegation setup for control buttons only
        function setupEventDelegation() {
            // Only handle specific control buttons by ID
            document.addEventListener('click', function(event) {
                if (event.target.id === 'refreshOrdersBtn') {
                    addLogMessage('üîÑ Refresh Orders button clicked');
                    event.preventDefault();
                    event.stopPropagation();
                    loadOrders();
                    return false;
                }
                
                if (event.target.id === 'logoutBtn') {
                    addLogMessage('üö™ Logout button clicked');
                    event.preventDefault();
                    event.stopPropagation();
                    logout();
                    return false;
                }
                
                if (event.target.id === 'clearLoginBtn') {
                    addLogMessage('üóëÔ∏è Clear Login button clicked');
                    event.preventDefault();
                    event.stopPropagation();
                    clearLoginState();
                    return false;
                }
            });
        }
    </script>
</body>
</html>
